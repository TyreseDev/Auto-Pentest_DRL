FROM ubuntu:22.04
LABEL org.opencontainers.image.authors="TyreseJin (tyresejin3915@gmail.com)"


# Install Dependencies
RUN apt-get update \
&& apt-get install -y --no-install-recommends \
  autoconf bison flex g++ graphviz libpcre3 libpcre3-dev \
  libcurl4 libcurl4-openssl-dev make openjdk-8-jdk-headless \
  vim wget xutils-dev dos2unix unixodbc-dev libmysqlclient-dev \
  texlive-font-utils ghostscript nmap python3 python3-pip \
  net-tools nano zip unzip curl git htop tmux gnupg gnupg-agent \
  software-properties-common ca-certificates lsb-release


# Copy Source
WORKDIR /root
COPY auto-pentest_drl auto-pentest_drl


# Copy MySQL Config
WORKDIR /root/auto-pentest_drl/mysql-config
RUN cp -f ./my.cnf /etc/mysql/


# Copy jni_md.h to new location (this resolvfes file not found warning for XSB)
WORKDIR /usr/lib/jvm/java-8-openjdk-amd64/include
RUN cp linux/jni_md.h .


# Set JAVA_HOME for XSB
ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64


# Install XSB
WORKDIR /root
RUN wget https://downloads.sourceforge.net/project/xsb/xsb/5.0%20%28Green%20Tea%29/XSB-5.0.tar.gz
RUN tar -xzf XSB-5.0.tar.gz && rm XSB-5.0.tar.gz

WORKDIR /root/XSB/build
RUN ./configure && ./makexsb
ENV PATH ${PATH}:/root/XSB/bin


# Install MulVAL
WORKDIR /root/auto-pentest_drl/repos/mulval
ENV MULVALROOT /root/auto-pentest_drl/repos/mulval
ENV PATH ${PATH}:${MULVALROOT}/bin:${MULVALROOT}/utils
RUN mkdir -p ./bin/adapter \
&& mkdir -p ./bin/metrics \
&& make


# Install Metasploit
WORKDIR /root/auto-pentest_drl/Penetration_tools
RUN apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys CDFB5FA52007B954 \
&& apt-get update \
&& wget https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb -O msfinstall \
&& chmod 755 msfinstall \
&& ./msfinstall \
&& rm ./msfinstall

RUN mkdir pymetasploit3 \
&& cd pymetasploit3 \
&& pip install pipenv \
&& pipenv install pymetasploit3


# Install Auto-Pentest_DRL's Dependencies
WORKDIR /root/auto-pentest_drl
RUN pip install --no-cache-dir -r requirements.txt


# Remove Caches
RUN apt-get clean \
&& rm -rf /var/lib/apt/lists/* \
&& rm -rf /var/cache/apt/archives/* \
&& rm -rf /root/.cache \
&& apt-get update


# Check Permissions
RUN chmod 777 -Rf /root/auto-pentest_drl


# Run Bash
CMD bash